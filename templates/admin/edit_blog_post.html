{% extends "admin/base_admin.html" %}

{% block title %}{% if post %}Modifier l'article{% else %}Nouvel Article{% endif %} - Admin{% endblock %}

{% block extra_css %}
<!-- TinyMCE CDN -->
<script src="https://cdn.tiny.cloud/1/no-api-key/tinymce/6/tinymce.min.js" referrerpolicy="origin"></script>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>
            <i class="bi bi-pencil-square"></i> 
            {% if post %}Modifier l'article{% else %}Nouvel Article{% endif %}
        </h1>
        <a href="{{ url_for('admin_blog_posts') }}" class="btn btn-secondary">
            <i class="bi bi-arrow-left"></i> Retour
        </a>
    </div>

    <form method="POST" enctype="multipart/form-data">
        <div class="row">
            <!-- Contenu principal -->
            <div class="col-lg-8">
                <!-- Titre FR -->
                <div class="card mb-3">
                    <div class="card-header bg-primary text-white">
                        <i class="bi bi-flag"></i> Version Française
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">Titre <span class="text-danger">*</span></label>
                            <input type="text" name="title" class="form-control" 
                                   value="{{ post.title if post else '' }}" required>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Extrait</label>
                            <textarea name="excerpt" class="form-control" rows="3" 
                                      placeholder="Court résumé de l'article (150-200 caractères)">{{ post.excerpt if post else '' }}</textarea>
                            <small class="text-muted">Utilisé pour le SEO et les aperçus</small>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Contenu <span class="text-danger">*</span></label>
                            <textarea name="content" id="content_fr" class="form-control tinymce-editor">{{ post.content if post else '' }}</textarea>
                        </div>
                    </div>
                </div>

                <!-- Titre EN -->
                <div class="card mb-3">
                    <div class="card-header bg-info text-white">
                        <i class="bi bi-flag"></i> English Version
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">Title</label>
                            <input type="text" name="title_en" class="form-control" 
                                   value="{{ post.title_en if post else '' }}">
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Excerpt</label>
                            <textarea name="excerpt_en" class="form-control" rows="3" 
                                      placeholder="Short summary (150-200 characters)">{{ post.excerpt_en if post else '' }}</textarea>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Content</label>
                            <textarea name="content_en" id="content_en" class="form-control tinymce-editor">{{ post.content_en if post else '' }}</textarea>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sidebar -->
            <div class="col-lg-4">
                <!-- Publication -->
                <div class="card mb-3">
                    <div class="card-header">
                        <i class="bi bi-send"></i> Publication
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">Statut</label>
                            <select name="is_published" class="form-select">
                                <option value="0" {% if post and not post.is_published %}selected{% endif %}>Brouillon</option>
                                <option value="1" {% if not post or post.is_published %}selected{% endif %}>Publié</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Catégorie <span class="text-danger">*</span></label>
                            <select name="blog_category" class="form-select" required>
                                <option value="">Sélectionner...</option>
                                <option value="nouveautés" {% if post and post.blog_category == 'nouveautés' %}selected{% endif %}>
                                    Nouveautés
                                </option>
                                <option value="conseils" {% if post and post.blog_category == 'conseils' %}selected{% endif %}>
                                    Conseils
                                </option>
                                <option value="tendances" {% if post and post.blog_category == 'tendances' %}selected{% endif %}>
                                    Tendances
                                </option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Auteur</label>
                            <input type="text" name="author" class="form-control" 
                                   value="{{ post.author if post else 'Admin' }}">
                        </div>

                        <button type="submit" class="btn btn-warning w-100">
                            <i class="bi bi-save"></i> 
                            {% if post %}Mettre à jour{% else %}Publier{% endif %}
                        </button>
                    </div>
                </div>

                <!-- Image -->
                <div class="card mb-3">
                    <div class="card-header">
                        <i class="bi bi-image"></i> Image à la une
                    </div>
                    <div class="card-body">
                        {% if post and post.image_url %}
                        <div class="mb-3">
                            <img src="{{ url_for('static', filename=post.image_url) }}" 
                                 class="img-fluid rounded" 
                                 alt="Image actuelle">
                            <div class="form-check mt-2">
                                <input class="form-check-input" type="checkbox" name="remove_image" id="remove_image">
                                <label class="form-check-label text-danger" for="remove_image">
                                    Supprimer l'image
                                </label>
                            </div>
                        </div>
                        {% endif %}

                        <div class="mb-3">
                            <label class="form-label">
                                {% if post and post.image_url %}Remplacer l'image{% else %}Image{% endif %}
                            </label>
                            <input type="file" name="image" class="form-control" accept="image/*">
                            <small class="text-muted">Format recommandé: 1200x630px (JPG, PNG, WebP)</small>
                        </div>
                    </div>
                </div>

                <!-- SEO -->
                <div class="card mb-3">
                    <div class="card-header">
                        <i class="bi bi-search"></i> SEO
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">Slug URL <span class="text-danger">*</span></label>
                            <input type="text" name="slug" class="form-control" 
                                   value="{{ post.slug if post else '' }}" 
                                   placeholder="mon-article-de-blog"
                                   pattern="[a-z0-9-]+"
                                   {% if not post %}required{% else %}readonly{% endif %}>
                            <small class="text-muted">
                                URL: /blog/<span id="slug-preview">{{ post.slug if post else 'mon-article' }}</span>
                            </small>
                        </div>

                        {% if post %}
                        <div class="alert alert-info small mb-0">
                            <i class="bi bi-info-circle"></i> 
                            <strong>{{ post.views }}</strong> vues
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<script>
// TinyMCE Configuration
tinymce.init({
    selector: '.tinymce-editor',
    height: 500,
    menubar: true,
    plugins: [
        'advlist', 'autolink', 'lists', 'link', 'image', 'charmap', 'preview',
        'anchor', 'searchreplace', 'visualblocks', 'code', 'fullscreen',
        'insertdatetime', 'media', 'table', 'code', 'help', 'wordcount'
    ],
    toolbar: 'undo redo | blocks | bold italic underline | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | link image | removeformat | code',
    content_style: 'body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; font-size: 16px; line-height: 1.6; }',
    language: 'fr_FR',
    branding: false,
    promotion: false
});

// Auto-generate slug from title
{% if not post %}
document.querySelector('input[name="title"]').addEventListener('input', function(e) {
    const title = e.target.value;
    const slug = title
        .toLowerCase()
        .normalize('NFD').replace(/[\u0300-\u036f]/g, '') // Remove accents
        .replace(/[^a-z0-9]+/g, '-') // Replace non-alphanumeric with hyphens
        .replace(/^-+|-+$/g, ''); // Remove leading/trailing hyphens
    
    document.querySelector('input[name="slug"]').value = slug;
    document.getElementById('slug-preview').textContent = slug || 'mon-article';
});
{% endif %}
</script>

{% endblock %}
