{% extends "admin/base_admin.html" %}

{% block title %}Modifier Produit - Admin{% endblock %}

{% block content %}
<div class="container py-5">
    <h1 class="mb-4">Modifier le Produit</h1>

    <div class="card">
        <div class="card-body">
            <form method="POST" action="{{ url_for('admin_edit_product', product_id=product.id) }}" enctype="multipart/form-data">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="name" class="form-label">Nom du Produit *</label>
                        <input type="text" class="form-control" id="name" name="name" value="{{ product.name }}" required>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="brand" class="form-label">Marque *</label>
                        <select class="form-select" id="brand" name="brand" required>
                            <option value="">Choisir une marque...</option>
                            {% for brand in brands %}
                            <option value="{{ brand }}" {% if product.brand == brand %}selected{% endif %}>{{ brand }}</option>
                            {% endfor %}
                            <option value="__new__">➕ Nouvelle marque...</option>
                        </select>
                    </div>
                </div>

                <!-- Nouvelle Marque (caché par défaut) -->
                <div class="mb-3" id="new-brand-field" style="display: none;">
                    <label for="new_brand" class="form-label">
                        <i class="bi bi-plus-circle"></i> Nom de la nouvelle marque
                    </label>
                    <input type="text" 
                           class="form-control" 
                           id="new_brand" 
                           name="new_brand" 
                           placeholder="Ex: Chanel, Dior...">
                </div>

                <div class="mb-3">
                    <label for="description" class="form-label">Description</label>
                    <textarea class="form-control" id="description" name="description" rows="4">{{ product.description or '' }}</textarea>
                </div>

                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label for="price" class="form-label">Prix (DH) *</label>
                        <input type="number" step="0.01" class="form-control" id="price" name="price" value="{{ product.price }}" required>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label for="stock" class="form-label">Stock *</label>
                        <input type="number" class="form-control" id="stock" name="stock" value="{{ product.stock }}" required>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label for="size" class="form-label">Taille</label>
                        <input type="text" class="form-control" id="size" name="size" value="{{ product.size or '' }}">
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="category_id" class="form-label">Catégorie *</label>
                        <select class="form-select" id="category_id" name="category_id" required>
                            {% for category in categories %}
                            <option value="{{ category.id }}" {% if product.category_id == category.id %}selected{% endif %}>
                                {{ category.name }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="is_decant" class="form-label">Type *</label>
                        <select class="form-select" id="is_decant" name="is_decant" required>
                            <option value="0" {% if not product.is_decant %}selected{% endif %}>Flacon Complet</option>
                            <option value="1" {% if product.is_decant %}selected{% endif %}>Décant</option>
                        </select>
                    </div>
                </div>

                <div class="mb-3">
                    {% if product.image_url %}
                    <div class="mb-2">
                        <p class="small text-muted">Image actuelle :</p>
                        <img src="/static/uploads/{{ product.image_url }}" width="120" class="rounded border me-2">
                    </div>
                    {% endif %}
                    <label for="image" class="form-label">Nouvelle Image (optionnel)</label>
                    <input type="file" class="form-control" id="image" name="image" accept="image/*" onchange="previewImage(event)">
                    <small class="form-text text-muted">Laisser vide pour conserver l'image actuelle</small>
                    
                    <!-- Prévisualisation nouvelle image -->
                    <div id="imagePreview" class="mt-3" style="display: none;">
                        <p class="small text-muted mb-2">Nouvelle image :</p>
                        <img id="previewImg" src="" alt="Prévisualisation" 
                             style="max-width: 200px; max-height: 200px; border-radius: 8px; border: 2px solid #dee2e6;">
                    </div>
                </div>

                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" id="is_featured" name="is_featured" 
                           {% if product.is_featured %}checked{% endif %}>
                    <label class="form-check-label" for="is_featured">
                        Produit en vedette
                    </label>
                </div>

                <div class="d-flex gap-2">
                    <button type="submit" class="btn btn-warning">
                        <i class="bi bi-check-circle"></i> Enregistrer les Modifications
                    </button>
                    <a href="{{ url_for('admin_products') }}" class="btn btn-secondary">Annuler</a>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Afficher/masquer le champ "nouvelle marque"
document.getElementById('brand').addEventListener('change', function() {
    const newBrandField = document.getElementById('new-brand-field');
    const newBrandInput = document.getElementById('new_brand');
    
    if (this.value === '__new__') {
        newBrandField.style.display = 'block';
        newBrandInput.required = true;
    } else {
        newBrandField.style.display = 'none';
        newBrandInput.required = false;
        newBrandInput.value = '';
    }
});

// Prévisualiser l'image sélectionnée
function previewImage(event) {
    const file = event.target.files[0];
    const preview = document.getElementById('imagePreview');
    const previewImg = document.getElementById('previewImg');
    
    if (file) {
        const reader = new FileReader();
        
        reader.onload = function(e) {
            previewImg.src = e.target.result;
            preview.style.display = 'block';
        }
        
        reader.readAsDataURL(file);
    } else {
        preview.style.display = 'none';
    }
}
</script>
{% endblock %}
